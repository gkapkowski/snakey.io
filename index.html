<!DOCTYPE html>
<html>
<head>
    <title>Snakes</title>
    <style type="text/css">
      canvas { border: 1px solid black; }
    </style>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
</head>
<body>
    <canvas id="board" width="600" height="600"></canvas>
    <script type="text/javascript">
        // snake's head is BLACK!

        var canvas = document.getElementById('board');
        var ctx = canvas.getContext('2d');

        const boardSize = 20;
        var board = [];

        const scale = 600/boardSize;

        let snakes = [
          [[2, 2], [2, 1], [2, 0]], // each snake is an array of snake elements' coordinates
          [[5, 5], [5, 4], [5, 3]]
        ];
        let apples = [[4, 4], [0, 0], [1, 3]];

        generateBoard(snakes, apples);
        (function loop(){
          setTimeout(function() {
            moveSnakes(snakes);
            generateBoard(snakes, apples);
            loop();
          }, 500);
        })();

        function generateBoard(snakes, apples) {
          board.length = 0;

          // create empty board
            for (var i = 0; i < boardSize; i++) {
              let row = new Array(boardSize);
              row.fill('.');
              board.push(row);
            }

          // fill board with apples
          for (var i = 0; i < apples.length; i++) {
            let [x, y] = apples[i];
            board[y][x] = 'o';
          }

          // draw snake
          for (var j = 0; j < snakes.length; j++) {
            let snake = snakes[j];
            for (var i = 0; i < snake.length; i++) {
              let [x, y] = snake[i];
              board[y][x] = i === 0 ? 'H' : '#';
            }
          }

          return board;
        }

        function draw() {
          for (let y = 0; y < board.length; y++) {
              let row = board[y];
              for (let x = 0; x < row.length; x++) {
                  let field = row[x];
                  switch (field) {
                      case ".":
                          ctx.fillStyle = 'rgb(255, 255, 255)';
                          ctx.fillRect(x * scale, y * scale, scale, scale);
                          break;
                      case "#":
                          ctx.fillStyle = 'rgb(120, 120, 120)';
                          ctx.fillRect(x * scale, y * scale, scale, scale);
                          break;
                      case "H":
                          ctx.fillStyle = 'rgb(0, 0, 0)';
                          ctx.fillRect(x * scale, y * scale, scale, scale);
                          break;
                      case "o":
                          ctx.fillStyle = 'rgb(200, 0, 0)';
                          ctx.beginPath();
                          ctx.arc(x * scale + parseInt(scale/2), y * scale + parseInt(scale/2), scale/2, 0, Math.PI*2);
                          ctx.fill();
                          break;
                  }

              }
          }
          window.requestAnimationFrame(draw);
        }

        function moveSnakes(snakes) {
          console.log('moving');
          for (var i = 0; i < snakes.length; i++) {
            let snake = snakes[i];
            let head = snake[0];
            let direction = snake1(board, head);
            /*
            when moving a snake, snake array must be updated as follows:
            - calculate new snake head position
            - add new head to snake array
            - remove last element from snake array
            */
            console.log(direction);
            let [x, y] = head;
            let newHeadX;
            let newHeadY;

            switch (direction) {
              case 'up':
                newHeadX = x;
                newHeadY = y - 1;
                break;
              case 'down':
                newHeadX = x;
                newHeadY = y +1;
                break;
              case 'left':
                newHeadX = x - 1;
                newHeadY = y;
                break;
              case 'right':
                newHeadX = x + 1;
                newHeadY = y;
                break;
            }


            /*
            remove last pair of coordinates, and add new ones as a new snake's head if move is possible
            */
            snake.pop();
            /*
            is move possible? - collision check with board edges
            */
            if (newHeadX < 0 || newHeadX >= boardSize || newHeadY < 0 || newHeadY >= boardSize) {
              console.log('not on board');
              snake.length = 0;
              return;
            }
            /*
            is move possible? - collision check with itself
            */
            // for (var of itter) {
            //
            // }
            /*
            is move possible? - collision check with other snakes
            */
            // for (var of itter) {
            //
            // }
            snake.unshift([newHeadX, newHeadY]);
          }

        }

        // snake1 is temporary name
        function snake1() {
          let directions = ['right', 'left', 'up', 'down'];
          let direction = _.sample(directions);

          return direction;
        }

        window.requestAnimationFrame(draw);

    </script>
</body>
</html>
